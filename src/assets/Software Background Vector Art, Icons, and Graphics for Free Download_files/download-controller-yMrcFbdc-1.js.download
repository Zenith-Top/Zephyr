import{a as S}from"./stimulus-helpers-Bg5ApOVk-1.js";import D from"./ez-base-controller-DuL8VR07-1.js";import{a as d}from"./js-Cz0CWeBA-1.js";import{d as w,g as z}from"./download-helpers-DVHSt0Mr-1.js";import{g as r,e as c,a as P}from"./ajax-helpers-vhfuGJDo-1.js";import{i as M}from"./flash-helpers-Bnxa3h-n-1.js";import{t as l}from"./helpers-SiW2vY12-1.js";import{k as g,l as R,m as T,n as U}from"./ez-custom-events-B9oXrnTo-1.js";import E from"./init-user-BlDnuGFC-1.js";import{r as m,t as p}from"./index-_O8rD79_-1.js";import"./stimulus-Cq41p_up-1.js";import"./index-C4xxlH8f-1.js";import"./_commonjsHelpers-BosuxZz1-1.js";import"./modal_helpers-CVMysF8B-1.js";function C(e,o){return m(2,arguments),p(e).getTime()-p(o).getTime()}var f={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(e){return e<0?Math.ceil(e):Math.floor(e)}},V="trunc";function _(e){return e?f[e]:f[V]}function A(e,o,a){m(2,arguments);var t=C(e,o)/1e3;return _(a==null?void 0:a.roundingMethod)(t)}const u=class u extends D{constructor(){super(...arguments),this.handleAutoDownload=()=>{this.downloadUrl=this.autoDownloadUrl,this.downloadSize=new URLSearchParams(this.downloadUrl).get("size")||this.downloadSize,d.remove("auto_download_url"),this.autoDlPathValue=null,this.openAdModal()},this.handleDownload=async(o=null)=>{var a;o==null||o.preventDefault(),!this.clickProcessing&&(this.clickProcessing=!0,this.downloadSize=((a=o==null?void 0:o.params)==null?void 0:a.dlSize)||this.downloadSize,this.setDownloadUrl(o),this.beforeDownload(),this.creditSpent?await this.download():this.download(),this.afterDownload())},this.openAdModal=(o=null)=>{var a;if(o==null||o.preventDefault(),!this.hasAdModalPathValue){this.handleDownload();return}this.downloadSize=((a=o==null?void 0:o.params)==null?void 0:a.dlSize)||this.downloadSize,this.setDownloadUrl(o),window.addEventListener("TriggerDownload",this.handleDownload,{once:!0}),r(this.adModalPathValue)}}connect(){this.setDownloadUrl(),this.downloadSize=null,this.flagLoaded(),this.autoDownloadUrl&&this.handleAutoDownload()}disconnect(){window.removeEventListener("TriggerDownload",this.handleDownload),window.removeEventListener("TriggerDownload",this.openAdModal)}handleDownloadResponse(o){const{url:a,type:t,error:i}=o.data;switch(t){case"download":return w({url:a});case"resize":return this.resizedDownload(a);case"resize_video":return this.resizedVideoDownload(a);case"modal":return r(a);case"redirect":return window.location.href=a,null;case"error":return M({referenceElement:document.querySelector(".ez-page-wrapper"),flashMessageText:i,classes:"ez-flash-message ez-flash-message--error ez-flash-message--flat ez-flash-message--floating ez-flash-message--auto-dismiss",icon:""}),null;default:return null}}resizedDownload(o){this.dispatch("toggleButtonLoading",{detail:{state:"on"}}),c({url:o,pollingNotCompleteCb:a=>{},pollingCompleteCondition:a=>a.data.url!==null,successCb:a=>{this.finishLoadingAndDownload({result:a})},errorCb:()=>{this.dispatch("toggleButtonLoading",{detail:{state:"off"}})},opts:{maxTries:300}})}resizedVideoDownload(o){this.dispatch("toggleButtonLoading",{detail:{state:"on"}}),l(R);const a=Date.now();c({url:o,pollingNotCompleteCb:t=>{l(g,{progress:t.data.progress})},pollingCompleteCondition:t=>t.data.url!==null,successCb:async t=>{l(g,{progress:100}),await this.waitForResizeComplete(a),this.finishLoadingAndDownload({result:t}),l(T)},errorCb:()=>{alert("There was an error resizing this resource."),l(U),this.dispatch("toggleButtonLoading",{detail:{state:"off"}})},opts:{maxTries:300}})}setDownloadUrl(o=null){var t,i,n;let a=((t=o==null?void 0:o.currentTarget)==null?void 0:t.href)||this.downloadUrl||this.downloadPathValue;(i=o==null?void 0:o.params)!=null&&i.dlSizeUrl&&(a=(n=o==null?void 0:o.params)==null?void 0:n.dlSizeUrl),a&&(this.downloadUrl=this.prepareDownloadUrl(a,this.licenseTypeValue,this.downloadSize))}prepareDownloadUrl(o,a=null,t=null){const[i,n]=o.split("?"),s=new URLSearchParams(n);return a&&s.set("license_type",a),t&&s.set("size",t),`${i}?${s.toString()}`}finishLoadingAndDownload({result:o}){const{url:a,filename:t}=o.data,{downloadSize:i}=this;this.dispatch("toggleButtonLoading",{detail:{state:"off"}}),w({url:a,filename:t,downloadSize:i,reloadPage:this.creditSpent})}maybeRedirectInsteadOfDownload(){["join_pro","trial","template"].includes(this.downloadTypeValue)&&(window.location.href=this.downloadUrl)}beforeDownload(){this.maybeRedirectInsteadOfDownload(),this.dispatch("beforeDownload",{detail:{licenseType:this.licenseTypeValue,resourceId:this.resourceIdValue}})}afterDownload(){z({onReload:this.creditSpent}),this.dispatch("afterDownload"),this.creditSpent&&window.setTimeout(()=>{window.location.reload()},1e3),setTimeout(()=>{this.clickProcessing=!1},1e3)}download(){return this.downloadTypeValue==="reactivate"?r(this.downloadUrl):P(this.downloadUrl,o=>{this.handleDownloadResponse(o)},o=>{console.error(o)})}openReturningSignInModal(o){o.preventDefault(),this.hasReturningSignInModalPathValue&&(d.set("auto_download_url",this.downloadUrl),this.downloadSize=o.params.dlSize,this.setDownloadUrl(o),window.addEventListener("TriggerDownload",this.openAdModal,{once:!0}),r(this.returningSignInModalPathValue))}openDunningModal(o){o.preventDefault(),this.hasDunningModalPathValue&&r(this.dunningModalPathValue)}spendCreditAndDownload(o=null){o==null||o.preventDefault(),this.creditSpent=!0,this.handleDownload()}openCreditSpendConfirm(o){var a;if(o.preventDefault(),this.downloadSize=((a=o==null?void 0:o.params)==null?void 0:a.dlSize)||this.downloadSize,this.licenseTypeValue!=="pro"||this.creditSpent){this.handleDownload(o);return}this.clickProcessing=!1,this.spendCreditAndDownload()}async waitForResizeComplete(o){const a=E.isPro?2:5;await new Promise(t=>{setInterval(()=>{A(Date.now(),o)>a&&t()},250)})}get autoDownloadUrl(){return d.get("auto_download_url")||this.autoDlPathValue}};u.values={adModalPath:String,resizeModalPath:String,resizeWaitingModalPath:String,autoDlPath:String,creditConfirmText:String,downloadPath:String,downloadType:String,downloadUrl:String,dunningModalPath:String,licenseType:String,resourceId:String,returningSignInModalPath:String};let h=u;S({name:"download",import:h});export{h as default};
