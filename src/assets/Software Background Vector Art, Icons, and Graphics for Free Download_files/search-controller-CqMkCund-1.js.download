import{a as d}from"./stimulus-helpers-Bg5ApOVk-1.js";import{a as c}from"./js-Cz0CWeBA-1.js";import l from"./ez-base-controller-DuL8VR07-1.js";import{e as i}from"./events-BkNvg-Hc-1.js";import{t as s,l as p}from"./helpers-SiW2vY12-1.js";import{F as u}from"./filters-state-BjbyzNKW-1.js";import{i as g}from"./search-helpers-DaR1ehXn-1.js";import"./stimulus-Cq41p_up-1.js";import"./init-user-BlDnuGFC-1.js";class m extends l{constructor(){super(...arguments),this.applySearchFilters=e=>{this.resetContentType(e),c.set("ezSearchType","internal");const t=window.filtersState.getFlatQueryString(),r=this.unverifiedPath||this.changingContentType()?this.getNewSearchUrl(this.searchRoute,this.searchTerm,t):`${window.location.pathname}${t}`;window.Turbo.visit(r)},this.postAjaxEvent=e=>{this.postAjax(e.detail.dataHash)},this.searchPaginationEvent=e=>{s("PaginationChanged",{page:e.detail.page,stateKey:"search-state",extraStates:["filterState"],ajaxEventName:"PostSearchAjax",resultsTarget:document.querySelector(".search-results")})},this.performSearch=e=>{const{searchPath:t}=e.detail,r=e.detail.searchRoute?e.detail.searchRoute:this.searchRoute,o=this.normalizeTerm(e.detail.term);this.resetContentType(e);const n=e.detail.useSearchState?window.filtersState.getFlatQueryString().substring(1):null,a=t||this.getNewSearchUrl(r,o,n);g(),e.detail.searchInNewTab===!0?window.open(a,"_blank"):window.Turbo.visit(a)},this.resetContentType=e=>{this.contentType=e.detail.contentType||this.contentType,e.detail.contentType&&c.set("content_type",e.detail.contentType),this.changingContentType()&&window.filtersState.resetStateToDefault()},this.postAjax=e=>{window.filtersState.updateStateValue("page",e.page);const t=window.filtersState.getFlatQueryString(),r=this.unverifiedPath||this.changingContentType()?this.getNewSearchUrl(this.searchRoute,this.searchTerm,t):`${window.location.pathname}${t}`;this.searchType&&c.set("ezSearchType",this.searchType),window.location.assign(r)},this.trackSearchClick=e=>{const t=e.target.closest(".search-results .ez-search-results .ez-resource-grid__item");t&&s(i.search.click,{resourceId:t.getAttribute("data-item-id"),resourcePosition:t.getAttribute("data-position"),resourcePro:t.getAttribute("data-pro"),searchTerm:this.searchTerm})},this.trackSponsoredSearchClick=e=>{const t=e.target.closest(".search-results .ez-sponsored-results .ez-resource-grid__item");t&&s(i.search.sponsored_click,{resourceId:t.getAttribute("data-item-id"),resourcePosition:t.getAttribute("data-position"),resourcePro:"",searchTerm:this.searchTerm,sponsored:!0})}}connect(){var e;window.filtersState=(e=window.filtersState)!=null&&e.isSearchState()?window.filtersState:new u,this.searchFormInput=document.querySelector('[data-search-form-target="input"]'),this.searchFormInput&&(this.contentType=this.searchFormInput.getAttribute("data-content-type"),window.location.href.indexOf("/free-png/")>-1&&(this.contentType="png")),window.addEventListener("PostSearchAjax",this.postAjaxEvent),window.addEventListener("SearchPaginationChange",this.searchPaginationEvent),window.addEventListener("Searched",this.performSearch),window.addEventListener("click",this.trackSearchClick),window.addEventListener("click",this.trackSponsoredSearchClick),window.addEventListener(i.search.apply_filters,this.applySearchFilters),window.addEventListener(i.search.update_content_type,this.resetContentType)}disconnect(){window.removeEventListener("PostSearchAjax",this.postAjaxEvent),window.removeEventListener("SearchPaginationChange",this.searchPaginationEvent),window.removeEventListener("Searched",this.performSearch),window.removeEventListener("click",this.trackSearchClick),window.removeEventListener("click",this.trackSponsoredSearchClick),window.removeEventListener(i.search.apply_filters,this.applySearchFilters),window.removeEventListener(i.search.update_content_type,this.resetContentType)}changingContentType(){return this.contentType!==this.searchFormInput.getAttribute("data-content-type")}getNewSearchUrl(e,t,r){const o=t.match(/url:.*/)||t.match(/id:.*/);if(window.location.pathname.includes("search_by_image")&&o)return`${window.location.pathname}${r}`;const n=e,a=[];return e===this.searchRoute&&a.push(`qterm=${t}`,`content_type=${this.contentType}`),r&&r.replace(/^\?/,"").split("&").forEach(h=>{a.push(h)}),a.length>0?`/${n}?${a.join("&")}`:n}footerPagerChange(e){e.preventDefault();const t=document.querySelector('[data-pagination-target="currentPage"]'),r=p(t)+1;s("SearchPaginationChange",{page:r})}normalizeTerm(e){return encodeURIComponent(e.toLowerCase().trim().replace(/ /g,"-"))}get searchRoute(){return this.searchFormInput?this.searchFormInput.getAttribute("data-search-route"):"search"}get searchTerm(){const e=this.element.querySelector("[data-search-term]");return e?e.getAttribute("data-search-term"):""}get searchType(){const e=this.element.querySelector("[data-search-type]");return e?e.getAttribute("data-search-type"):null}get unverifiedPath(){return window.location.pathname===`/${this.searchRoute}`}}d({name:"search",import:m});export{m as default};
